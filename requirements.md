# シフト管理システム 要件定義書

**バージョン**: 1.0  
**最終更新日**: 2025年11月15日  
**ステータス**: モックMVP版

---

## 📋 目次

1. [プロジェクト概要](#プロジェクト概要)
2. [現状と課題](#現状と課題)
3. [システム化の目的](#システム化の目的)
4. [対象範囲](#対象範囲)
5. [機能要件](#機能要件)
6. [非機能要件](#非機能要件)
7. [制約条件](#制約条件)
8. [データ仕様](#データ仕様)
9. [運用フロー](#運用フロー)
10. [開発フェーズ](#開発フェーズ)
11. [技術スタック](#技術スタック)

---

## 📌 プロジェクト概要

### 基本情報
- **対象企業**: ANA関連の下請け会社
- **管理人数**: 約150名
- **配属箇所数**: 約50箇所（5カテゴリ）
- **運用サイクル**: 月次シフト作成

### プロジェクトの背景
Excel運用による150名規模のシフト管理が限界を迎えており、以下の課題が発生している：
- シフト作成に膨大な時間がかかる
- 配置ミス（資格・役職要件の抜け漏れ）が発生
- 急な欠勤時の対応が電話連絡で非効率
- 属人化により担当者の負担が大きい

---

## 🚨 現状と課題

### 現在の運用方法
1. スタッフがExcelに希望を記入（◯×形式）
2. 月20日頃までに希望表を提出
3. 管理者がExcelでシフトを手作業で作成
4. 確定後、Excel/PDFで配布
5. 急な変更時は電話で個別連絡

### 主な課題
| 課題 | 詳細 | 影響度 |
|------|------|--------|
| 作業時間 | 50箇所×150人の割り当てに膨大な時間 | ⭐⭐⭐⭐⭐ |
| 配置ミス | 資格・役職要件のチェック漏れ | ⭐⭐⭐⭐⭐ |
| 急な変更 | 欠勤時の電話連絡が非効率 | ⭐⭐⭐⭐ |
| 属人化 | 特定担当者に依存 | ⭐⭐⭐ |
| 制約管理 | 夜勤明けルール等の確認が煩雑 | ⭐⭐⭐ |

---

## 🎯 システム化の目的

### 最終ゴール
スタッフの希望をアップロードするだけで、AIが全ての制約条件を考慮して最適なシフトを自動生成するシステム

### 短期目標（モックMVP版）
1. シフト作成時間の50%削減
2. 配置ミス（資格・役職要件）のゼロ化
3. シフト管理の標準化・脱属人化
4. 基本的な制約チェックの自動化

### 長期目標（フル版）
1. AI完全自動割り当て
2. 急な変更時の一斉通知機能
3. スタッフ向けアプリでのシフト確認
4. 過去データからの学習・最適化

---

## 📍 対象範囲

### 対象ユーザー
- **管理者**: シフト作成・管理を行う担当者（1-2名想定）
- **スタッフ**: 150名の従業員（モックでは対象外）

### 対象業務
- **月次シフト作成**: 翌月分のシフト割り当て
- **配置管理**: 配属箇所への人員配置
- **制約チェック**: 資格・役職・勤務ルールの確認
- **出力**: Excel/PDF形式での配布

### 対象外（後のフェーズで実装）
- スタッフによる希望入力機能（Web化）
- 急な変更時の一斉通知
- スタッフ向けアプリ
- 勤怠管理・給与計算との連携

---

## ⚙️ 機能要件

### フェーズ1: モックMVP版（今回実装）

#### 1. マスタ管理機能
| 機能 | 詳細 | 優先度 |
|------|------|--------|
| スタッフ管理 | 社員番号、氏名、連絡先、役職、タグの登録・編集 | ⭐⭐⭐⭐⭐ |
| 配属箇所管理 | 配属箇所の登録、必要人数・タグ・役職の設定 | ⭐⭐⭐⭐⭐ |
| 勤務記号管理 | 勤務記号（28種類）の登録、時刻・休憩の自動計算 | ⭐⭐⭐⭐⭐ |
| タグ管理 | 技能・資格タグの自由な作成・編集 | ⭐⭐⭐⭐ |
| 役職管理 | 役職の登録、責任者フラグの設定 | ⭐⭐⭐⭐ |

#### 2. 希望提出管理
| 機能 | 詳細 | 優先度 |
|------|------|--------|
| Excel取り込み | 現行の希望表フォーマットをアップロード・パース | ⭐⭐⭐⭐⭐ |
| 希望データ表示 | スタッフ別・日付別の希望を一覧表示 | ⭐⭐⭐⭐ |

#### 3. シフト作成機能
| 機能 | 詳細 | 優先度 |
|------|------|--------|
| 手動割り当て | カレンダー/表形式でのドラッグ&ドロップ配置 | ⭐⭐⭐⭐⭐ |
| リアルタイムチェック | 配置時に制約違反を即座に警告表示 | ⭐⭐⭐⭐⭐ |
| 配置状況の可視化 | 各配属箇所の充足率・不足人数を表示 | ⭐⭐⭐⭐ |

#### 4. 制約チェック機能
| 制約内容 | チェック方法 | 優先度 |
|----------|--------------|--------|
| 必要人数 | 配属箇所ごとの最低人数を満たしているか | ⭐⭐⭐⭐⭐ |
| 責任者配置 | 必要な配属箇所に責任者が配置されているか | ⭐⭐⭐⭐⭐ |
| 必要タグ | 配属箇所の必要タグを持つ人が配置されているか | ⭐⭐⭐⭐⭐ |
| 夜勤明けルール | 夜勤翌日の勤務制限（将来実装） | ⭐⭐⭐ |
| 連続勤務制限 | 連続勤務日数の上限チェック（将来実装） | ⭐⭐⭐ |

#### 5. 出力機能
| 機能 | 詳細 | 優先度 |
|------|------|--------|
| Excel出力 | 現行フォーマットに準じた形式で出力 | ⭐⭐⭐⭐⭐ |
| CSV出力 | 汎用的なCSV形式で出力 | ⭐⭐⭐⭐ |
| PDF出力 | 印刷用PDF生成（将来実装） | ⭐⭐ |

#### 6. 履歴管理
| 機能 | 詳細 | 優先度 |
|------|------|--------|
| 変更履歴 | いつ誰が何を変更したかを記録 | ⭐⭐⭐ |
| バージョン管理 | シフトの版管理（将来実装） | ⭐⭐ |

---

### フェーズ2: 運用改善版（将来実装）
- スタッフのWeb希望提出機能
- 制約ルールのカスタマイズ機能
- より詳細な制約チェック（労働時間、連続勤務等）
- シフト比較機能

### フェーズ3: 自動化・通知版（将来実装）
- AI自動割り当てアルゴリズム
- 急な変更時の一斉通知（メール/LINE/Slack）
- スタッフ向けアプリ（シフト確認）
- 過去データ分析・最適化提案

---

## 🔒 非機能要件

### パフォーマンス
- シフト作成画面の操作レスポンス: 500ms以内
- データ保存: 2秒以内
- Excel出力: 5秒以内

### 可用性
- 稼働率: 95%以上（モックMVP版）
- バックアップ: 日次自動バックアップ

### セキュリティ
- 認証: Supabase認証によるログイン必須
- 権限管理: 管理者のみアクセス可能（RLS設定）
- データ暗号化: 通信時・保存時ともに暗号化

### 拡張性
- スタッフ数: 500名まで対応可能な設計
- 配属箇所: 100箇所まで対応可能な設計
- 将来的なAPI連携を考慮した設計

### ユーザビリティ
- 直感的なUI/UX（ドラッグ&ドロップ操作）
- レスポンシブデザイン（PC/タブレット対応）
- 日本語UI

---

## ⚠️ 制約条件

### 技術的制約
- 開発期間: モックMVP版は2-3週間程度
- 予算: 最小限（無料枠中心の構成）
- 開発リソース: 1名（AI駆動開発）

### 業務的制約
- 現行Excelフォーマットとの互換性維持
- 段階的な移行（いきなり全機能は不要）
- 既存業務フローへの影響を最小化

### データ制約
- 個人情報保護: 社員番号・氏名・連絡先の適切な管理
- データ保持期間: 過去1年分のシフトデータを保持

---

## 📊 データ仕様

### 勤務記号フォーマット
**記号構造**: `[開始時][開始分][勤務時間][勤務分][休憩]`

**例**: `06G5DA`
- `06`: 6時台
- `G`: 30分（A=0, B=5, C=10... 5分刻み）
- `5`: 5時間（**0は10時間として扱う**）
- `D`: 15分（A=0, B=5, C=10... 5分刻み）
- `A`: 休憩なし（無=1時間、A=なし、Y=1.5時間、W=2時間）

**結果**: 6:30-11:45（5時間15分勤務、休憩なし）

### 勤務記号一覧（28種類）
| カテゴリ | 勤務記号数 | 主な記号例 |
|----------|------------|------------|
| T3中央（第3ターミナル中央保安検査場） | 12種類 | 06A6AA, 06G5DA, 18A5AA, 22A9AY |
| T3北（第3ターミナル北側検査場） | 3種類 | 06J0AW, 15A7J, 17J5AA |
| T2中央（第2ターミナル国際線検査場） | 5種類 | 06A6AA, 19A5AA, 19A5GA |
| バス案内業務 | 10種類 | 04J5AA, 05D8G, 18J6AA |
| 横特業務（東方航空バゲージ） | 1種類 | 05G4AA |

### 勤務帯の種類
希望表で使用される勤務帯：
- **早朝**: 4:00-11:00
- **早番**: 6:00-16:00
- **遅番**: 13:00-23:00
- **夜勤**: 19:00-10:00（最大8時間）
- **◯**: 勤務OK（時間帯指定なし）
- **休**: 休み希望

### 配属箇所カテゴリ
| カテゴリ | 説明 | 備考 |
|----------|------|------|
| 保安検査場案内業務 | T3中央、T3北、T2中央 | 青色業務（際際バス業務） |
| バス案内業務 | - | 黄土色業務（OSS+バスor番台） |
| 横特業務 | 東方航空バゲージ | - |

### スタッフ情報
- 社員番号: 4桁の数字
- 氏名: フルネーム
- 連絡先: メールアドレス、電話番号
- 役職: 後で定義（仮: 一般社員、サブリーダー、リーダー、管理者）
- タグ: 技能・資格（複数保有可能）

---

## 🔄 運用フロー

### 月次シフト作成フロー（モックMVP版）

```
【現行フロー】
① スタッフ → Excel希望表記入
② 提出期限: 前月20日頃
③ 管理者 → 手作業でシフト作成
④ 確定 → Excel/PDF配布
⑤ 急な変更 → 電話で個別連絡

【システム化後（モックMVP版）】
① スタッフ → Excel希望表記入（従来通り）
          ↓
② 管理者 → システムにExcelアップロード
          ↓
③ システム → 希望データをパース・表示
          ↓
④ 管理者 → ドラッグ&ドロップでシフト割り当て
          ↓
⑤ システム → リアルタイムで制約チェック
          ↓  （⚠️資格不足、⚠️責任者未配置 等を表示）
⑥ 管理者 → 調整・修正
          ↓
⑦ 確定 → Excel/CSV出力して配布
          ↓
⑧ システム → 変更履歴を自動記録

【将来的な完全自動化フロー】
① スタッフ → Excel希望表記入
          ↓
② 管理者 → Excelアップロード
          ↓
③ AI → 自動でシフト生成（全制約考慮）
          ↓
④ 管理者 → 確認・微調整（必要なら）
          ↓
⑤ 確定 → 自動配布 + 一斉通知
```

---

## 🏗️ 開発フェーズ

### フェーズ1: モックMVP版（2-3週間）✅ ← 今ココ
**目標**: 基本的なシフト管理機能を実装し、運用可能な状態にする

**成果物**:
- スタッフ・配属箇所・勤務記号のマスタ管理
- Excel希望表の取り込み
- 手動でのシフト割り当て画面
- 基本的な制約チェック
- Excel/CSV出力

**完了条件**:
- 実際の月次シフトが作成できる
- 制約違反が可視化される
- Excelで出力できる

---

### フェーズ2: 運用改善版（1-2ヶ月後）
**目標**: 運用の効率化と精度向上

**追加機能**:
- より詳細な制約チェック（労働時間、連続勤務等）
- 制約ルールのカスタマイズ機能
- シフト比較機能
- 変更履歴の詳細表示

**完了条件**:
- 労働基準法準拠のチェックが可能
- 過去シフトとの比較ができる

---

### フェーズ3: 自動化・通知版（3-6ヶ月後）
**目標**: AI自動割り当てと通知機能の実装

**追加機能**:
- AI自動割り当てアルゴリズム
- スタッフのWeb希望提出機能
- 急な変更時の一斉通知（メール/LINE/Slack）
- スタッフ向けアプリ（シフト確認）

**完了条件**:
- AIが80%以上の精度でシフトを自動生成
- 急な変更が即座に全員に通知される

---

## 🛠️ 技術スタック

### フロントエンド
- **フレームワーク**: Next.js 14（App Router）
- **言語**: TypeScript
- **UI**: TailwindCSS
- **状態管理**: React Hooks（必要に応じてZustand）
- **カレンダーUI**: FullCalendar or react-big-calendar

### バックエンド
- **BaaS**: Supabase
  - PostgreSQL（データベース）
  - Row Level Security（RLS）
  - Realtime Subscriptions
  - Storage（将来的にファイル保存用）

### インフラ
- **ホスティング**: Vercel（Next.js）
- **データベース**: Supabase（PostgreSQL）
- **認証**: Supabase Auth

### 開発ツール
- **パッケージマネージャー**: npm/yarn
- **バージョン管理**: Git
- **デプロイ**: Vercel（自動デプロイ）

### ライブラリ
- **Excel解析**: xlsx
- **Excel生成**: exceljs
- **日付処理**: date-fns
- **バリデーション**: zod
- **型安全**: TypeScript strict mode

---

## 📐 データベース設計（概要）

### テーブル一覧

#### 1. スタッフテーブル (staff)
```sql
id: UUID (主キー)
employee_number: TEXT (社員番号)
name: TEXT (氏名)
email: TEXT (連絡先)
phone: TEXT (電話番号)
role_id: UUID (役職ID)
tags: TEXT[] (タグ配列)
is_active: BOOLEAN (在籍中)
created_at: TIMESTAMP
updated_at: TIMESTAMP
```

#### 2. 役職マスタ (roles)
```sql
id: UUID (主キー)
name: TEXT (役職名)
is_responsible: BOOLEAN (責任者になれるか)
priority: INTEGER (優先度)
created_at: TIMESTAMP
```

#### 3. タグマスタ (tags)
```sql
id: UUID (主キー)
name: TEXT (タグ名)
description: TEXT (説明)
created_at: TIMESTAMP
```

#### 4. 勤務記号マスタ (duty_codes)
```sql
id: UUID (主キー)
code: TEXT UNIQUE (勤務記号: 06G5DA)
start_time: TIME (開始時刻)
end_time: TIME (終了時刻)
duration_hours: INTEGER (勤務時間)
duration_minutes: INTEGER (勤務分)
break_minutes: INTEGER (休憩時間)
is_overnight: BOOLEAN (日またぎ)
category: TEXT (カテゴリ)
created_at: TIMESTAMP
updated_at: TIMESTAMP
```

#### 5. 配属箇所 (locations)
```sql
id: UUID (主キー)
business_type: TEXT (業務種別)
location_name: TEXT (場所名)
code: TEXT (略称)
is_active: BOOLEAN (使用中)
created_at: TIMESTAMP
updated_at: TIMESTAMP
```

#### 6. 配属箇所要件 (location_requirements)
```sql
id: UUID (主キー)
location_id: UUID (配属箇所ID)
duty_code_id: UUID (勤務記号ID)
required_staff_count: INTEGER (必要人数)
required_responsible_count: INTEGER (必要責任者数)
required_tags: TEXT[] (必要タグ)
day_of_week: INTEGER (曜日 0-6)
specific_date: DATE (特定日)
created_at: TIMESTAMP
```

#### 7. 希望提出 (shift_requests)
```sql
id: UUID (主キー)
staff_id: UUID (スタッフID)
date: DATE (日付)
request_type: TEXT (◯/休/早朝/早番/遅番/夜勤)
note: TEXT (備考)
year_month: TEXT (年月 YYYY-MM)
created_at: TIMESTAMP
updated_at: TIMESTAMP
```

#### 8. シフト (shifts)
```sql
id: UUID (主キー)
staff_id: UUID (スタッフID)
location_id: UUID (配属箇所ID)
duty_code_id: UUID (勤務記号ID)
date: DATE (日付)
status: TEXT (予定/確定/変更/キャンセル)
note: TEXT (備考)
created_at: TIMESTAMP
updated_at: TIMESTAMP
created_by: UUID (作成者)
updated_by: UUID (更新者)
```

### リレーション
```
staff → role (多対一)
shift → staff (多対一)
shift → location (多対一)
shift → duty_code (多対一)
shift_request → staff (多対一)
location_requirement → location (多対一)
location_requirement → duty_code (多対一)
```

---

## 📝 補足事項

### 今後の検討事項
1. **役職の具体的な定義**: 実際の役職名と権限を確認
2. **必要人数の変動ルール**: 曜日パターン・特定日パターンの詳細
3. **タグの初期リスト**: 実際に使用する技能・資格タグの洗い出し
4. **労働時間の制約**: 法定労働時間、週の上限等のルール確認
5. **スタッフの組み合わせNG**: 特定ペアのNG設定が必要か

### モックMVP版での割り切り
- 役職は仮設定で進める（後で調整可能）
- 配属箇所は画像にある5カテゴリのみ
- 勤務記号は28種類で固定
- スタッフは仮データで10-20名程度
- 制約チェックは基本的なもののみ（資格・人数・責任者）

---

## ✅ 承認

| 役割 | 氏名 | 承認日 |
|------|------|--------|
| 要件定義者 | いっき | 2025/11/15 |

---

**以上**
