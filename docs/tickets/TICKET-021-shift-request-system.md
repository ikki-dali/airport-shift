# TICKET-021: シフト希望管理システム

## 概要

バイト・社員が提出したシフト希望を管理し、AI自動生成時に反映するシステム

## 背景・目的

- バイトや社員から送られてくるシフト希望（休み希望、勤務希望など）を効率的に管理したい
- メール・LINE・Excelなど、様々な方法で提出される希望を一元管理
- AI自動生成時に希望を考慮してシフトを組む

## 実装フェーズ

### ✅ フェーズ0：基盤実装（完了）

#### データベース
- `shift_requests` テーブル（既存）
  - `staff_id`: スタッフID
  - `date`: 日付
  - `request_type`: 希望タイプ（◯/休/早朝/早番/遅番/夜勤）
  - `note`: メモ
  - `year_month`: 年月

#### 管理者機能
- ✅ 希望設定モーダル（手動入力）
- ✅ AI生成時の希望考慮ロジック
- ✅ データ保存・更新（upsert）

#### AI生成への反映
- ✅ 「休」希望 → シフトに入れない（必須）
- ✅ 「◯」希望 → できるだけシフトに入れる
- ✅ 時間帯希望 → 該当する勤務記号を割り当て

---

### ✅ フェーズ1：既存希望の表示（完了）

**目的**: 希望設定画面を開いたときに、既に保存されている希望を表示

#### 実装内容
1. **希望データの読み込み**
   - 画面を開いたときに、その週の希望データを取得
   - `getShiftRequests({ yearMonth, staffId, date })` を使用

2. **初期値の設定**
   - 取得した希望データを state に反映
   - セレクトボックスに既存の値を表示

3. **更新フロー**
   - 既存の希望がある場合 → 表示して編集可能に
   - 新規入力 → 通常通り保存
   - どちらも `upsert` で処理

#### 技術詳細
```typescript
// ShiftRequestModal.tsx
useEffect(() => {
  if (open) {
    loadExistingRequests()
  }
}, [open, weekDays])

const loadExistingRequests = async () => {
  const yearMonth = format(weekDays[0], 'yyyy-MM')
  const requests = await getShiftRequests({ yearMonth })
  // state に反映
}
```

---

### ✅ フェーズ2：バイト用入力サイト（完了）

**目的**: バイト・社員が自分でシフト希望を入力できるようにする

#### 2-1. アーキテクチャ選択

**案A: トークンベース（ログイン不要）**
- URL: `/shift-request/{staff_token}`
- スタッフごとにユニークなトークンを発行
- トークンを知っている人だけアクセス可能
- メリット：実装が簡単、バイトに使いやすい
- デメリット：URLが漏れるとアクセスされる

**案B: 簡易ログイン**
- URL: `/shift-request/login`
- 社員番号 + 生年月日でログイン
- メリット：セキュリティが高い
- デメリット：バイトの手間が増える

**推奨: 案A（トークンベース）から開始**

#### 2-2. 実装内容

##### データベース拡張
```sql
-- staff テーブルに token カラムを追加
ALTER TABLE staff ADD COLUMN request_token TEXT UNIQUE;

-- 既存スタッフ用のトークン生成
UPDATE staff
SET request_token = gen_random_uuid()::text
WHERE request_token IS NULL;
```

##### 画面構成
1. **入力画面** `/shift-request/[token]/page.tsx`
   - トークンからスタッフ情報を取得
   - カレンダー形式で希望を入力
   - 保存ボタン → DB に保存

2. **確認画面** `/shift-request/[token]/confirm`
   - 提出済みの希望を確認
   - 編集・削除も可能

##### セキュリティ
- トークンの有効性チェック
- Rate limiting（連続アクセス制限）
- CSRF 対策

#### 2-3. 管理者機能
- スタッフ一覧にトークンURL表示
- QRコード生成（スマホで簡単アクセス）
- トークン再発行機能

#### 2-4. 通知機能（オプション）
- 希望提出締め切りリマインダー
- 提出完了通知（管理者へ）

---

### 🔜 フェーズ3：Excelインポート機能（優先度：中）

**目的**: Excelで送られてきた希望シートを一括インポート

#### 3-1. 対応フォーマット

**例: シフト希望表.xlsx**
```
スタッフ名 | 社員番号 | 11/17 | 11/18 | 11/19 | ...
山田太郎   | 0001    | ◯    | 休    | 早番  | ...
佐藤花子   | 0002    | 休    | ◯    | -     | ...
```

#### 3-2. 実装内容

##### アップロード画面
- `/requests/import` ページ
- ドラッグ&ドロップでファイルアップロード
- プレビュー機能
- エラーチェック

##### パースロジック
```typescript
// lib/parsers/shift-request-parser.ts
export function parseShiftRequestExcel(file: File): ParsedRequest[] {
  // 1. Excelファイルを読み込み
  // 2. ヘッダーから日付を抽出
  // 3. 各行からスタッフと希望を抽出
  // 4. バリデーション
  // 5. データベース形式に変換
}
```

##### エラーハンドリング
- 社員番号が存在しない
- 日付フォーマットが不正
- 希望タイプが不正（◯/休以外）
- 重複データ

#### 3-3. インポートフロー
1. ファイル選択
2. プレビュー表示（エラーがあれば赤字表示）
3. 上書き or 追加 を選択
4. インポート実行
5. 完了通知（○件インポート、○件エラー）

---

## データフロー全体像

```
【バイト・社員】
    ↓
┌───────────────────┐
│ 1. 希望提出方法    │
├───────────────────┤
│ A. Web入力        │ → /shift-request/{token}
│ B. Excel送付      │ → 管理者がインポート
│ C. メール・LINE   │ → 管理者が手入力
└───────────────────┘
    ↓
┌───────────────────┐
│ 2. データベース    │
│ shift_requests   │
└───────────────────┘
    ↓
┌───────────────────┐
│ 3. 管理者画面     │
│ ・希望設定で確認   │
│ ・必要に応じて修正 │
└───────────────────┘
    ↓
┌───────────────────┐
│ 4. AI自動生成     │
│ ・希望を考慮       │
│ ・最適なシフト作成 │
└───────────────────┘
    ↓
【完成したシフト】
```

---

## API設計

### 管理者用
```typescript
// 希望一覧取得
GET /api/shift-requests?yearMonth=2025-11&staffId=xxx

// 一括登録・更新
POST /api/shift-requests/bulk
Body: [{ staff_id, date, request_type }]

// 削除
DELETE /api/shift-requests?staffId=xxx&date=2025-11-17
```

### バイト用
```typescript
// 自分の希望取得
GET /api/shift-requests/my?token=xxx&yearMonth=2025-11

// 希望提出
POST /api/shift-requests/submit
Body: { token, requests: [...] }
```

---

## 画面遷移図

### 管理者フロー
```
シフト作成画面
  ├─ [希望設定] → 希望設定モーダル
  │               ├─ 既存希望を表示
  │               ├─ 編集・追加
  │               └─ 保存
  │
  ├─ [インポート] → インポート画面（フェーズ3）
  │                 ├─ ファイル選択
  │                 ├─ プレビュー
  │                 └─ インポート
  │
  └─ [AIで自動生成] → AI生成
                      └─ 希望を考慮したシフト作成
```

### バイトフロー
```
トークンURLにアクセス
  ↓
入力画面
  ├─ カレンダー表示
  ├─ 希望を選択（◯/休/早番など）
  └─ [提出] → 確認画面
              └─ [確定] → 完了
```

---

## セキュリティ考慮事項

### バイト入力サイト
- ✅ トークンの推測困難性（UUID使用）
- ✅ Rate limiting（1分間に10リクエストまで）
- ✅ CSRF対策
- ❌ SQL injection対策（Supabaseが自動対応）
- ⚠️ トークン漏洩時の対応（再発行機能）

### 管理者画面
- ✅ 認証必須（Supabase Auth）
- ✅ Row Level Security
- ✅ 操作ログ（将来実装）

---

## テストシナリオ

### フェーズ1
- [x] 希望設定画面を開いたときに既存希望が表示される
- [x] 既存希望を編集して保存できる
- [x] 新規希望を追加できる

### フェーズ2
- [x] トークンURLにアクセスできる
- [x] 自分の希望を入力・提出できる
- [x] 提出した希望を確認・編集できる
- [x] 無効なトークンでアクセスするとエラー
- [x] 管理者画面に反映される

### フェーズ3
- [ ] Excelファイルをアップロードできる
- [ ] プレビューで内容を確認できる
- [ ] エラーがある場合は警告が表示される
- [ ] インポート実行後、DBに保存される

---

## パフォーマンス考慮

- インデックス: `shift_requests(staff_id, date)`
- キャッシュ: よくアクセスされる月の希望データ
- ページネーション: 大量データ対応

---

## 今後の拡張案

### 承認フロー
- バイトが提出 → 管理者が承認 → 確定
- ステータス管理（提出/承認/却下）

### 通知機能
- 締め切りリマインダー
- 提出完了メール
- 変更通知

### 分析機能
- 希望提出率の可視化
- 希望が多い日の分析
- スタッフ別の傾向分析

---

## 関連チケット

- TICKET-019: AI自動割当機能（希望考慮ロジック）
- TICKET-007: Excel一括インポート（参考実装）

---

## 実装サマリー

### フェーズ2実装内容（2025-11-17完了）

#### データベース
- `supabase/migrations/20251117000001_add_request_token_to_staff.sql`
  - staff テーブルに request_token カラムを追加
  - UUID形式のトークンを既存スタッフに自動生成
  - インデックスを作成してトークン検索を高速化

#### Server Actions
- `lib/actions/staff-tokens.ts` (新規作成)
  - `getStaffByToken()`: トークンからスタッフ情報を取得
  - `generateStaffToken()`: スタッフのトークンを生成・再発行
  - `getAllStaffTokens()`: 全スタッフのトークン情報を取得（管理者用）
  - `getTokenUrl()`: トークンURLを生成

#### バイト用画面
- `app/shift-request/[token]/page.tsx` (新規作成)
  - トークンベースの認証
  - 2週間分の希望入力フォーム
  - 既存希望の自動読み込み

- `components/shift-request/ShiftRequestForm.tsx` (新規作成)
  - カレンダー形式の希望入力UI
  - リアルタイムプレビュー
  - 送信成功時のフィードバック

#### 管理者機能
- `components/staff/StaffSearch.tsx` (更新)
  - スタッフ一覧にトークンURL表示列を追加
  - ワンクリックでURLをクリップボードにコピー
  - コピー完了のビジュアルフィードバック

#### 型定義
- `types/database.ts` (更新)
  - staff テーブルの型定義に request_token を追加

### セキュリティ実装
- ✅ UUID v4によるトークン生成（推測困難）
- ✅ トークンの一意性制約
- ✅ 無効なトークンへのアクセスは404エラー
- ✅ Server Actions によるサーバーサイド検証

### 使い方
1. **管理者**: スタッフ一覧画面で「URLコピー」ボタンをクリック
2. **管理者**: コピーしたURLをスタッフに送付（LINE、メールなど）
3. **スタッフ**: URLにアクセスして希望を入力・提出
4. **管理者**: 希望設定モーダルで提出された希望を確認
5. **管理者**: AIで自動生成ボタンをクリック → 希望が反映されたシフトが生成される

## 更新履歴

- 2025-11-17: 初版作成
- 2025-11-17: フェーズ1完了（既存希望の表示）
- 2025-11-17: フェーズ2完了（バイト用入力サイト）
